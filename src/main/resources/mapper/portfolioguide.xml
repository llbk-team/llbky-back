<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.portfolio.dao.PortfolioGuideDao">

    <!-- í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì´ë“œ ìƒì„± -->
    <insert id="insertGuide" parameterType="PortfolioGuide"
            useGeneratedKeys="true" keyProperty="guideId">
        INSERT INTO portfolio_guide(
            member_id, title, standard_id, guide_content, 
            completion_percentage, is_completed, current_step, total_steps,
            guide_feedback
        ) 
        VALUES(
            #{memberId}, #{title}, #{standardId}, 
            <choose>
                <when test="guideContent != null">
                    CAST(#{guideContent} AS JSONB)
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>,
            #{completionPercentage}, #{isCompleted}, #{currentStep}, #{totalSteps},
            <choose>
                <when test="guideFeedback != null">
                    CAST(#{guideFeedback} AS JSONB)
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>
        )
    </insert>

    <!-- ê°€ì´ë“œ IDë¡œ ì¡°íšŒ -->
    <select id="selectGuideById" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE guide_id = #{guideId}
    </select>

    <!-- íšŒì›ë³„ ê°€ì´ë“œ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectGuidesByMemberId" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE member_id = #{memberId}
        ORDER BY updated_at DESC
    </select>

    <!-- ì™„ë£Œëœ ê°€ì´ë“œ ì¡°íšŒ -->
    <select id="selectCompletedGuidesByMemberId" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE member_id = #{memberId} AND is_completed = true
        ORDER BY updated_at DESC
    </select>

    <!-- ì§„í–‰ ì¤‘ì¸ ê°€ì´ë“œ ì¡°íšŒ -->
    <select id="selectInProgressGuidesByMemberId" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE member_id = #{memberId} AND is_completed = false
        ORDER BY updated_at DESC
    </select>

    <!-- íŠ¹ì • í‰ê°€ ê¸°ì¤€ìœ¼ë¡œ ê°€ì´ë“œ ì¡°íšŒ -->
    <select id="selectGuidesByStandardId" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE standard_id = #{standardId}
        ORDER BY updated_at DESC
    </select>

    <!-- ê°€ì´ë“œ ì—…ë°ì´íŠ¸ -->
    <update id="updateGuide" parameterType="PortfolioGuide">
        UPDATE portfolio_guide 
        SET 
            title = #{title},
            guide_content = 
            <choose>
                <when test="guideContent != null">
                    CAST(#{guideContent} AS JSONB)
                </when>
                <otherwise>
                    guide_content
                </otherwise>
            </choose>,
            completion_percentage = #{completionPercentage},
            is_completed = #{isCompleted},
            current_step = #{currentStep},
            guide_feedback = 
            <choose>
                <when test="guideFeedback != null">
                    CAST(#{guideFeedback} AS JSONB)
                </when>
                <otherwise>
                    guide_feedback
                </otherwise>
            </choose>,
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>

    <!-- ê°€ì´ë“œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ 
    <update id="updateGuideProgress" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            completion_percentage = #{completionPercentage},
            current_step = #{currentStep},
            is_completed = #{isCompleted},
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>-->

    <!-- ê°€ì´ë“œ ì§„í–‰ë¥ ë§Œ ì—…ë°ì´íŠ¸ -->
    <update id="updateGuideProgressOnly" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            completion_percentage = #{completionPercentage},
            current_step = #{currentStep},
            is_completed = #{isCompleted},
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>

    <!-- ðŸ”¥ ê°€ì´ë“œ ì½˜í…ì¸  ì—…ë°ì´íŠ¸ (Map íŒŒë¼ë¯¸í„° ì§€ì›) -->
    <update id="updateGuideContent" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            guide_content = CAST(#{guideContent} AS JSONB),
            <if test="completionPercentage != null">
            completion_percentage = #{completionPercentage},
            </if>
            <if test="currentStep != null">
            current_step = #{currentStep},
            </if>
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>
    
    <!-- ðŸ”¥ ì „ì²´ ê°€ì´ë“œ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ (Map íŒŒë¼ë¯¸í„°) -->
    <update id="updateGuideProgress" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            guide_content = CAST(#{guideContent} AS JSONB),
            completion_percentage = #{completionPercentage},
            current_step = #{currentStep},
            <if test="isCompleted != null">
            is_completed = #{isCompleted},
            </if>
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>

    <!-- AI ê°€ì´ë“œ í”¼ë“œë°± ì—…ë°ì´íŠ¸ -->
    <update id="updateGuideFeedback" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            guide_feedback = CAST(#{feedback} AS JSONB),
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>

    <!-- ê°€ì´ë“œ ì™„ë£Œ ì²˜ë¦¬ -->
    <update id="completeGuide" parameterType="int">
        UPDATE portfolio_guide 
        SET 
            completion_percentage = 100,
            is_completed = true,
            current_step = total_steps,
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>

    <!-- ê°€ì´ë“œ ì‚­ì œ -->
    <delete id="deleteGuide" parameterType="int">
        DELETE FROM portfolio_guide 
        WHERE guide_id = #{guideId}
    </delete>

    <!-- íšŒì›ì˜ ëª¨ë“  ê°€ì´ë“œ ì‚­ì œ -->
    <delete id="deleteGuidesByMemberId" parameterType="int">
        DELETE FROM portfolio_guide 
        WHERE member_id = #{memberId}
    </delete>

    <!-- ê°€ì´ë“œ ê°œìˆ˜ ì¡°íšŒ -->
    <select id="countGuidesByMemberId" parameterType="int" resultType="int">
        SELECT COUNT(*) 
        FROM portfolio_guide 
        WHERE member_id = #{memberId}
    </select>

    <!-- ì™„ë£Œëœ ê°€ì´ë“œ ê°œìˆ˜ ì¡°íšŒ -->
    <select id="countCompletedGuidesByMemberId" parameterType="int" resultType="int">
        SELECT COUNT(*) 
        FROM portfolio_guide 
        WHERE member_id = #{memberId} AND is_completed = true
    </select>

    <!-- í‰ê·  ì™„ë£Œìœ¨ ì¡°íšŒ -->
    <select id="getAverageCompletionByMemberId" parameterType="int" resultType="double">
        SELECT COALESCE(AVG(completion_percentage), 0) 
        FROM portfolio_guide 
        WHERE member_id = #{memberId}
    </select>

    <!-- ìµœê·¼ ìƒì„±ëœ ê°€ì´ë“œ ì¡°íšŒ (ê´€ë¦¬ìžìš©) -->
    <select id="selectRecentGuides" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- íŠ¹ì • í‰ê°€ ê¸°ì¤€ë³„ ê°€ì´ë“œ í†µê³„ -->
    <select id="countGuidesByStandardId" parameterType="int" resultType="int">
        SELECT COUNT(*) 
        FROM portfolio_guide 
        WHERE standard_id = #{standardId}
    </select>

    <!-- íŠ¹ì • í‰ê°€ ê¸°ì¤€ë³„ ì™„ë£Œëœ ê°€ì´ë“œ ìˆ˜ -->
    <select id="countCompletedGuidesByStandardId" parameterType="int" resultType="int">
        SELECT COUNT(*) 
        FROM portfolio_guide 
        WHERE standard_id = #{standardId} AND is_completed = true
    </select>

    

</mapper>