<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.portfolio.dao.PortfolioGuideDao">

    <!-- í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì´ë“œ ìƒì„± -->
    <insert id="insertGuide" parameterType="PortfolioGuide"
            useGeneratedKeys="true" keyProperty="guideId">
        INSERT INTO portfolio_guide(
            member_id, title, standard_id, guide_content, 
            completion_percentage, is_completed, current_step, total_steps,
            appropriateness_score, progress_percentage, coaching_message,
            suggestions, examples, next_step_guide
        ) 
        VALUES(
            #{memberId}, #{title}, #{standardId}, 
            <choose>
                <when test="guideContent != null">
                    CAST(#{guideContent} AS JSONB)
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>,
            #{completionPercentage}, #{isCompleted}, #{currentStep}, #{totalSteps},
            #{appropriatenessScore}, #{progressPercentage}, #{coachingMessage},
            <choose>
                <when test="suggestions != null">
                    CAST(#{suggestions} AS JSONB)
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>,
            <choose>
                <when test="examples != null">
                    CAST(#{examples} AS JSONB)
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>,
            #{nextStepGuide}
        )
    </insert>

    <!-- ê°€ì´ë“œ IDë¡œ ì¡°íšŒ -->
    <select id="selectGuideById" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE guide_id = #{guideId}
    </select>

    <!-- íšŒì›ë³„ ê°€ì´ë“œ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectGuidesByMemberId" parameterType="int" resultType="PortfolioGuide">
        SELECT 
            guide_id,
            member_id,
            title,
            standard_id,
            guide_content,
            completion_percentage,
            is_completed,
            current_step,
            total_steps,
            guide_feedback,
            created_at,
            updated_at
        FROM portfolio_guide 
        WHERE member_id = #{memberId}
        ORDER BY updated_at DESC
    </select>

    <!-- ðŸ”¥ ê°€ì´ë“œ ì½˜í…ì¸  ì—…ë°ì´íŠ¸ (Map íŒŒë¼ë¯¸í„° ì§€ì›) -->
    <update id="updateGuideContent" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            guide_content = CAST(#{guideContent} AS JSONB),
            <if test="completionPercentage != null">
            completion_percentage = #{completionPercentage},
            </if>
            <if test="currentStep != null">
            current_step = #{currentStep},
            </if>
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>
    
    <!-- ðŸ”¥ ì „ì²´ ê°€ì´ë“œ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ (Map íŒŒë¼ë¯¸í„°) -->
    <update id="updateGuideProgress" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            guide_content = CAST(#{guideContent} AS JSONB),
            completion_percentage = #{completionPercentage},
            current_step = #{currentStep},
            
            <if test="isCompleted != null">
            is_completed = #{isCompleted},
            </if>
            updated_at = NOW()
        WHERE guide_id = #{guideId}
    </update>

    <!-- ðŸ”¥ AI ê°€ì´ë“œ í”¼ë“œë°± ì—…ë°ì´íŠ¸ (ê°œë³„ í•„ë“œ) -->
    <update id="updateGuideFeedback" parameterType="map">
        UPDATE portfolio_guide 
        SET 
            guide_feedback = CAST(#{guideFeedback} AS JSONB),
            updated_at = NOW()

        WHERE guide_id = #{guideId}
    </update>

</mapper>