<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.portfolio.dao.PortfolioEvaluationCriteriaDao">

    <!-- 평가 기준 생성 -->
    <insert id="insertCriteria" parameterType="PortfolioEvaluationCriteria"
            useGeneratedKeys="true" keyProperty="criteriaId">
        INSERT INTO portfolio_evaluation_criteria(
            job_group, job_role, career_level, criteria_name, 
            criteria_description, prompt_template, weight_percentage, is_active
        ) VALUES(
            #{jobGroup}, #{jobRole}, #{careerLevel}, #{criteriaName},
            #{criteriaDescription}, #{promptTemplate}, #{weightPercentage}, #{isActive}
        )
    </insert>

    <!-- 평가 기준 ID로 조회 -->
    <select id="selectCriteriaById" parameterType="int" resultType="PortfolioEvaluationCriteria">
        SELECT 
            criteria_id AS criteriaId,
            job_group AS jobGroup,
            job_role AS jobRole,
            career_level AS careerLevel,
            criteria_name AS criteriaName,
            criteria_description AS criteriaDescription,
            prompt_template AS promptTemplate,
            weight_percentage AS weightPercentage,
            is_active AS isActive
        FROM portfolio_evaluation_criteria 
        WHERE criteria_id = #{criteriaId}
    </select>

    <!-- 직군/직무/경력별 평가 기준 조회 -->
    <select id="selectCriteriaByJobInfo" parameterType="map" resultType="PortfolioEvaluationCriteria">
        SELECT 
            criteria_id AS criteriaId,
            job_group AS jobGroup,
            job_role AS jobRole,
            career_level AS careerLevel,
            criteria_name AS criteriaName,
            criteria_description AS criteriaDescription,
            prompt_template AS promptTemplate,
            weight_percentage AS weightPercentage,
            is_active AS isActive
        FROM portfolio_evaluation_criteria 
        WHERE job_group = #{jobGroup} 
        AND career_level = #{careerLevel}
        <if test="jobRole != null">
            AND job_role = #{jobRole}
        </if>
        AND is_active = true
        ORDER BY weight_percentage DESC
    </select>

    <!-- 활성화된 모든 평가 기준 조회 -->
    <select id="selectActiveCriteria" resultType="PortfolioEvaluationCriteria">
        SELECT 
            criteria_id AS criteriaId,
            job_group AS jobGroup,
            job_role AS jobRole,
            career_level AS careerLevel,
            criteria_name AS criteriaName,
            criteria_description AS criteriaDescription,
            prompt_template AS promptTemplate,
            weight_percentage AS weightPercentage,
            is_active AS isActive
        FROM portfolio_evaluation_criteria 
        WHERE is_active = true
        ORDER BY job_group, career_level, weight_percentage DESC
    </select>

    <!-- 평가 기준 수정 -->
    <update id="updateCriteria" parameterType="PortfolioEvaluationCriteria">
        UPDATE portfolio_evaluation_criteria SET 
            job_group = #{jobGroup},
            job_role = #{jobRole},
            career_level = #{careerLevel},
            criteria_name = #{criteriaName},
            criteria_description = #{criteriaDescription},
            prompt_template = #{promptTemplate},
            weight_percentage = #{weightPercentage},
            is_active = #{isActive}
        WHERE criteria_id = #{criteriaId}
    </update>

    <!-- 평가 기준 활성/비활성 토글 -->
    <update id="toggleCriteriaStatus" parameterType="map">
        UPDATE portfolio_evaluation_criteria 
        SET is_active = #{isActive}
        WHERE criteria_id = #{criteriaId}
    </update>

    <!-- 평가 기준 삭제 -->
    <delete id="deleteCriteria" parameterType="int">
        DELETE FROM portfolio_evaluation_criteria 
        WHERE criteria_id = #{criteriaId}
    </delete>

    <!-- 직군별 평가 기준 개수 조회 -->
    <select id="countCriteriaByJobGroup" parameterType="String" resultType="int">
        SELECT COUNT(*) 
        FROM portfolio_evaluation_criteria 
        WHERE job_group = #{jobGroup} AND is_active = true
    </select>

    <!-- 모든 직군 목록 조회 -->
    <select id="selectDistinctJobGroups" resultType="String">
        SELECT DISTINCT job_group 
        FROM portfolio_evaluation_criteria 
        WHERE is_active = true
        ORDER BY job_group
    </select>

</mapper>