<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.newstrend.dao.NewsSummaryDao">

    <!-- 뉴스 저장 -->
    <insert id="insertNewsSummary" 
      parameterType="NewsSummary" 
      useGeneratedKeys="true" 
      keyProperty="summaryId">
        insert into news_summary (
            member_id,
            source_name,
            source_url,
            title,
            published_at,
            summary_text,
            detail_summary,
            analysis_json,
            keywords_json
        )
        VALUES (
            #{memberId},
            #{sourceName},
            #{sourceUrl},
            #{title},
            #{publishedAt},
            #{summaryText},
            #{detailSummary},
            CAST(#{analysisJson} AS JSONB),
            CAST(#{keywordsJson} AS JSONB)
        )
    </insert>

    <!-- 단일 뉴스 조회 -->
    <select id="selectNewsSummaryById" 
      resultType="NewsSummary">
        select
          summary_id,
          member_id,
          source_name,
          source_url,
          title,
          published_at,
          summary_text,
          detail_summary,
          analysis_json,
          keywords_json,
          created_at
        from news_summary
        where summary_id = #{summaryId}
    </select>

    <!-- URL 중복 체크 -->
    <select id="selectNewsSummaryBySourceUrl" 
      resultType="NewsSummary">
        select
          summary_id,
          member_id,
          source_name,
          source_url,
          title,
          published_at,
          summary_text,
          detail_summary,
          analysis_json,
          keywords_json,
          created_at
        from news_summary
        where source_url = #{sourceUrl}
        LIMIT 1
    </select>

    <!-- 특정 멤버의 뉴스 조회 -->
    <select id="selectLatestNewsByMemberId" 
      resultType="NewsSummary">
        select
          summary_id,
          member_id,
          source_name,
          source_url,
          title,
          published_at,
          summary_text,
          detail_summary,
          analysis_json,
          keywords_json,
          created_at
        from news_summary
        where member_id = #{memberId}
        order by created_at DESC
        limit #{limit}
    </select>

    <!-- 특정 멤버의 특정 시간 뉴스 조회 -->
    <select id="selectNewsByMemberAndDate" resultType="NewsSummary">
      select
        summary_id,
        member_id,
        title,
        source_name,
        source_url,
        published_at,
        summary_text,
        detail_summary,
        analysis_json,
        keywords_json,
        created_at
        
      from
        news_summary
      where
       member_id = #{memberId}
      AND 
        DATE(created_at) = #{date}
      ORDER BY created_at DESC
      LIMIT #{limit}

    </select>



    <!-- 뉴스 삭제 -->
    <delete id="deleteNewsSummary">
        delete from news_summary
        where summary_id = #{summaryId}
    </delete>

</mapper>
