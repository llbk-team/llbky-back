<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.portfolio.dao.PortfolioDao">
<!-- ////////////////////////////////////////////////////////////////생성 -->
 <insert id="insertPortfolio" parameterType="Portfolio"
   useGeneratedKeys="true" keyProperty="portfolioId">
    INSERT INTO portfolio(
      member_id, title, pdf_file, original_filename, content_type, page_count, portfolio_feedback, created_at, updated_at
    ) 
    VALUES(
    #{memberId}, #{title}, #{pdfFile}, #{originalFilename}, #{contentType}, #{pageCount},
    <choose>
        <when test="portfolioFeedback != null">
          #{portfolioFeedback}::jsonb
        </when>
        <otherwise>
          NULL
        </otherwise>
      </choose>,
      NOW()
    )
  </insert>

 <!--/////////////////////////////////////////////////////////////////수정 -->

  <update id="updatePortfolio" parameterType="Portfolio">
    UPDATE portfolio
    SET title = #{title},
    updated_at = NOW()
    <if test="pdfFile != null">
        , pdf_file = #{pdfFile}
    </if>
    <if test="originalFilename != null">
        , original_filename = #{originalFilename}
    </if>
    <if test="contentType != null">
        , content_type = #{contentType}
    </if>
    <if test="pageCount != null">
        , page_count = #{pageCount}
    </if>
    <if test="portfolioFeedback != null">
      , portfolio_feedback = #{portfolioFeedback}::jsonb
    </if>
    WHERE portfolio_id = #{portfolioId}
  </update>

  <!-- AI 피드백 업데이트 (JSONB 컬럼) -->
  <update id="updatePortfolioFeedback" parameterType="map">
    UPDATE portfolio 
    SET 
      portfolio_feedback = #{feedback}::jsonb,
      updated_at = NOW()
    WHERE portfolio_id = #{portfolioId}
  </update>


  <!-- 포트폴리오 updated_at 갱신 -->
   <!-- 포트폴리오 updated_at 갱신 -->
  <update id="updatePortfolioTimestamp" parameterType="int">
    UPDATE portfolio 
    SET updated_at = NOW()
    WHERE portfolio_id = #{portfolioId}
  </update>




<!--/////////////////////////////////////////////////////////삭제-->

<delete id="deletePortfolio" parameterType="int">
  DELETE FROM portfolio
  WHERE portfolio_id=#{portfolioId}
</delete>

  <!-- 회원의 모든 포트폴리오 삭제 -->
  <delete id="deletePortfoliosByMemberId" parameterType="int">
    DELETE FROM portfolio 
    WHERE member_id = #{memberId}
  </delete>

  <!-- ##### 통계 및 유틸리티 ##### -->
  <!-- 전체 포트폴리오 개수 조회 -->
  <select id="countAllPortfolios" resultType="int">
    SELECT COUNT(*) 
    FROM portfolio
  </select>

  <!-- 특정 회원의 포트폴리오 개수 조회 -->
  <select id="countPortfoliosByMemberId" 
          parameterType="int" 
          resultType="int">
    SELECT COUNT(*) 
    FROM portfolio 
    WHERE member_id = #{memberId}
  </select>

  <!-- 최근 생성된 포트폴리오 조회 (관리자용) -->
  <select id="selectRecentPortfolios" 
          parameterType="int" 
          resultType="Portfolio">
    SELECT 
      portfolio_id AS portfolioId,
      member_id AS memberId,
      title,
      pdf_file AS pdfFile,
      original_filename AS originalFilename,
      content_type AS contentType,
      page_count AS pageCount,
      portfolio_feedback AS portfolioFeedback,
      created_at AS createdAt,
      updated_at AS updatedAt
    FROM portfolio 
    ORDER BY created_at DESC
    LIMIT #{limit}
  </select>

<!--/////////////////////////////////////////////////////////조회 -->

<!-- 포트폴리오 ID로 조회 -->
  <select id="selectPortfolioById" 
          parameterType="int" 
          resultType="Portfolio">
    SELECT 
      portfolio_id AS portfolioId,
      member_id AS memberId,
      title,
      pdf_file AS pdfFile,
      original_filename AS originalFilename,
      content_type AS contentType,
      page_count AS pageCount,
      portfolio_feedback AS portfolioFeedback,
      created_at AS createdAt,
      updated_at AS updatedAt
    FROM portfolio 
    WHERE portfolio_id = #{portfolioId}
  </select>

  <!-- 회원별 포트폴리오 목록 조회 -->
  <select id="selectPortfoliosByMemberId" 
          parameterType="int" 
          resultType="Portfolio">
    SELECT 
      portfolio_id AS portfolioId,
      member_id AS memberId,
      title,
      pdf_file AS pdfFile,
      original_filename AS originalFilename,
      content_type AS contentType,
      page_count AS pageCount,
      portfolio_feedback AS portfolioFeedback,
      created_at AS createdAt,
      updated_at AS updatedAt
    FROM portfolio 
    WHERE member_id = #{memberId}
    ORDER BY created_at DESC
  </select>

  <!-- 모든 포트폴리오 조회 -->
  <select id="selectAllPortfolios" resultType="Portfolio">
    SELECT 
      portfolio_id AS portfolioId,
      member_id AS memberId,
      title,
      pdf_file AS pdfFile,
      original_filename AS originalFilename,
      content_type AS contentType,
      page_count AS pageCount,
      portfolio_feedback AS portfolioFeedback,
      created_at AS createdAt,
      updated_at AS updatedAt
    FROM portfolio 
    ORDER BY created_at DESC
  </select>



</mapper>