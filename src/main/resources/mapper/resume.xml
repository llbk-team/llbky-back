<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.resume.dao.ResumeDao">

<!--이령서 생성-->
<insert id="insertResume" parameterType="Resume"
  useGeneratedKeys="true" keyProperty="resumeId">
    INSERT INTO resume(
      member_id, title, career_info, education_info, skills, 
      certificates, awards, activities, resume_feedback, created_at, updated_at
    )VALUES(
      #{memberId}, #{title}, 
      #{careerInfo}::jsonb, #{educationInfo}::jsonb, #{skills}::jsonb,
      #{certificates}::jsonb, #{awards}::jsonb, #{activities}::jsonb,
      #{resumeFeedback}::jsonb, NOW(), NOW()
    )
  </insert>

  <!-- 이력서 상세 조회-->
   <select id="selectResumeById" resultType="Resume">
        SELECT resume_id, member_id, title, 
               career_info::text as careerInfo,
               education_info::text as educationInfo,
               skills::text as skills,
               certificates::text as certificates,
               awards::text as awards,
               activities::text as activities,
               resume_feedback::text as resumeFeedback,
               created_at, updated_at
        FROM resume 
        WHERE resume_id = #{resumeId}
    </select>

    <!-- 회원별 이력서 목록 조회 -->
    <select id="selectResumesByMemberId" resultType="Resume">
        SELECT resume_id, member_id, title, 
               career_info::text as careerInfo,
               education_info::text as educationInfo,
               skills::text as skills,
               certificates::text as certificates,
               awards::text as awards,
               activities::text as activities,
               resume_feedback::text as resumeFeedback,
               created_at, updated_at
        FROM resume 
        WHERE member_id = #{memberId}
        ORDER BY updated_at DESC
    </select>

    <!-- 이력서 수정 -->
    <update id="updateResume" parameterType="Resume">
        UPDATE resume SET 
            title = #{title},
            career_info = #{careerInfo}::jsonb,
            education_info = #{educationInfo}::jsonb,
            skills = #{skills}::jsonb,
            certificates = #{certificates}::jsonb,
            awards = #{awards}::jsonb,
            activities = #{activities}::jsonb,
            resume_feedback = #{resumeFeedback}::jsonb,
            updated_at = NOW()
        WHERE resume_id = #{resumeId}
    </update>

     <!-- AI 피드백만 업데이트 -->
    <update id="updateResumeFeedback" parameterType="map">
        UPDATE resume SET 
            resume_feedback = #{feedback}::jsonb,
            updated_at = NOW()
        WHERE resume_id = #{resumeId}
    </update>

    <!-- 이력서 삭제 -->
    <delete id="deleteResume" parameterType="int">
        DELETE FROM resume 
        WHERE resume_id = #{value}
    </delete>

    <!-- 이력서 검색 -->
    <select id="searchResumes" parameterType="map" resultType="Resume">
        SELECT resume_id, member_id, title, 
               career_info::text as careerInfo,
               education_info::text as educationInfo,
               skills::text as skills,
               certificates::text as certificates,
               awards::text as awards,
               activities::text as activities,
               resume_feedback::text as resumeFeedback,
               created_at, updated_at
        FROM resume 
        WHERE member_id = #{memberId}
        <if test="keyword != null and keyword != ''">
            AND (
                title ILIKE '%' || #{keyword} || '%' 
                OR career_info::text ILIKE '%' || #{keyword} || '%'
                OR skills::text ILIKE '%' || #{keyword} || '%'
            )
        </if>
        ORDER BY updated_at DESC
    </select>

    <!-- 이력서 개수 조회 -->
    <select id="countResumesByMemberId" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM resume 
        WHERE member_id = #{memberId}
    </select>

    <!-- 최신 이력서 목록 (AI 분석용) -->
    <select id="selectRecentResumes" parameterType="int" resultType="Resume">
        SELECT resume_id, member_id, title, 
               career_info::text as careerInfo,
               education_info::text as educationInfo,
               skills::text as skills,
               certificates::text as certificates,
               awards::text as awards,
               activities::text as activities,
               resume_feedback::text as resumeFeedback,
               created_at, updated_at
        FROM resume 
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    
</mapper>