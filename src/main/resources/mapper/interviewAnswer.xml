<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.interview.dao.InterviewAnswerDao">
  <!-- 답변 제출 -->
  <insert id="insertInterviewAnswer" 
          parameterType="com.example.demo.interview.entity.InterviewAnswer"
          useGeneratedKeys="true"
          keyProperty="answerId"
  >
    INSERT INTO interview_answer
      (question_id, audio_file, video_file, answer_text, answer_feedback, created_at, updated_at)
    VALUES
      (#{questionId}, #{audioFile}, #{videoFile}, #{answerText}, CAST(#{answerFeedback} AS JSONB), NOW(), NOW())
  </insert>

  <!-- 답변 다시 제출 -->
  <update id="updateInterviewAnswer" parameterType="com.example.demo.interview.entity.InterviewAnswer">
    UPDATE interview_answer
    SET audio_file = #{audioFile}, 
        video_file = #{videoFile}, 
        answer_text = #{answerText}, 
        answer_feedback = CAST(#{answerFeedback} AS JSONB), 
        updated_at = NOW()
    WHERE answer_id = #{answerId}
  </update>

  <!-- 면접 질문 선택 시 연관된 답변 조회 -->
  <select id="selectInterviewAnswerByQuestionId" resultType="com.example.demo.interview.entity.InterviewAnswer">
    SELECT answer_id AS answerId,
           question_id AS questionId, 
           audio_file AS audioFile, 
           video_file AS videoFile, 
           answer_text AS answerText, 
           answer_feedback::text AS answerFeedback, 
           created_at AS createdAt,
           updated_at AS updatedAt
    FROM interview_answer
    WHERE question_id = #{questionId}
  </select>

</mapper>